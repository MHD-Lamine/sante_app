FROM python:3.12.2

# ğŸ“ Dossier de travail dans le conteneur
WORKDIR /app

# ğŸ§ª Copier les dÃ©pendances d'abord pour optimisation du cache Docker
COPY requirements.txt .

# ğŸ”§ Installer les paquets Python
RUN pip install --no-cache-dir -r requirements.txt

# ğŸ“‚ CrÃ©er le dossier des logs cron
RUN mkdir -p /var/log && touch /var/log/cron.log

# ğŸ“¦ Copier tous les fichiers du projet (y compris reset_meds.sh et meds-cron)
COPY . .

# âœ… Donner les bons droits APRÃˆS avoir copiÃ© les fichiers
RUN chmod +x reset_meds.sh \
    && chmod 0644 meds-cron

# ğŸ“Œ Enregistrer la tÃ¢che cron dans le systÃ¨me
RUN apt-get update && apt-get install -y cron curl \
    && crontab meds-cron

# ğŸ“¡ Exposer le port Flask
EXPOSE 5000

# ğŸŸ¢ DÃ©marrer le service cron + l'app Flask
CMD cron && python run.py
